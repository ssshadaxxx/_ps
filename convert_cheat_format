<#
    Convert NES Cheat Files
    v0.1
    July 27th, 2025

    By:      Robert Suarez
    Contact: RobertSuarezJr@gmail.com

    .SYNOPSIS
    Converts XML Cheat Files used for Nestopia to other emulator formats (i.e. FCEUX, Nestopia, Mesen)

    .DESCRIPTION
    Takes the existing XMLs from the $CheatRootPath parameter and creates new files compatible with other emulators

    .EXAMPLE
    Set $CheatRootPath and $TargetPath parameters:

        $CheatRootPath - Full path to folder containing XMLs cheats
            Set this path to where the XML files exist
            Example: D:\nes\cheats\Nestopia.Cheat.Code.Pack.2024-05-08\Nestopia Cheat Code Pack


        $TargetPath    - Full target path for converted cheat files
            Set this path to where you want the converted files stored.
            Example: D:\nes\cheats

    .INPUTS
    The Nestopia XML Cheat File Directory

    .OUTPUTS
    The New Cheat Files for alternate emulators

    .NOTES
    Must be in UTF8 format (for FCEUX, presumably all)
#>

Param (
    $CheatRootPath = "D:\nes\cheats\Nestopia.Cheat.Code.Pack.2024-05-08\Nestopia Cheat Code Pack",
    $TargetPath    = "D:\nes\cheats"
)

# Gather Nestopia Cheat Files
$NesCheatXMLs = Get-ChildItem $CheatRootPath

# Test with Punch-Out!
# $NesCheatXMLs = Get-ChildItem $CheatRootPath | ?{$_.name -eq "Mike Tyson's Punch-Out!! (Japan, USA) (En) (Rev 1).xml"} | select -first 1

# Initiate counter for progress indication
$Counter = 0

foreach ($Game in $NesCheatXMLs) {
    # Increment counter, display progress information
    $Counter++
    "$($Game.Name) - $Counter \ $($NesCheatXMLs.Count)"

    # Load XML Data
    [xml]$xmlData = Get-Content -Path $Game.FullName
    $CheatData = $xmlData.cheats.cheat
    $GetDate = Get-Date -Format 'yyyy-MM-dd'

    #### Create FCEUX Format ####
    # Format:
    # S + <ADDRESS> + : + <VALUE> + : + <DESCRIPTION>
    #

    #
    # Examples:
    # S0001:01:Start on match 02 - Von Keiser
    # SC8080:00:e5:Invincibility (1 of 2)
    # SCa290:f8:01:Skip intro
    # SC82b5:75:f5:Invincibility (2 of 2)

    # Set FCEUX Directory, create if needed
    $FCEUXPath       = $TargetPath + '\FCEUX' + ".Cheat.Code.Pack.$GetDate"
    New-Item -Path $FCEUXPath -ItemType Directory -ErrorAction SilentlyContinue

    # Set Game Cheat Path for FCEUX, file format = .cht
    $FCEUXCheatFile = $FCEUXPath + "\$($Game.Name.Replace('.xml','.cht'))"

    # Initiate Blank Converted Cheat File (adds blank to deal with an issue where the first cheat occasionally does not work for some reason, example 1942 - Infinite Lives)
    $ConvertedCheats = "`n"

    # Build New Converted Cheat File
    foreach ($Cheat in $CheatData) {
        if ($Cheat.genie -and $Cheat.compare) {
            # If value for 'genie', need value for 'compare'
            # SC + <ADDRESS> + <VALUE> + : + <COMPARE> + : + <DESCRIPTION>
            $ConvertedCheats += "SC" + $Cheat.address.ToLower().Replace('0x','') + ':' + $Cheat.value.ToLower().Replace('0x','') + ':' + $Cheat.compare.ToLower().Replace('0x','') + ':' + $Cheat.description + "`n"
        } else {
            # S + <ADDRESS> + : + <VALUE> + : + <DESCRIPTION>
            $ConvertedCheats += "S" + $Cheat.address.ToLower().Replace('0x','') + ':' + $Cheat.value.ToLower().Replace('0x','') + ':' + $Cheat.description + "`n"
        }
        "Added: $($ConvertedCheats | Select -Last 1)"
    }

    # Export Converted Cheat file - UTF8 encoding
    $ConvertedCheats.TrimEnd() | Out-File $FCEUXCheatFile -Encoding UTF8
}
